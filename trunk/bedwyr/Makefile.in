all: src/bedwyr

.PHONY: src/bedwyr
src/bedwyr: src/Makefile Makefile
	make -C src bedwyr

src/Makefile: src/Makefile.in configure
	./configure

Makefile: Makefile.in configure
	./configure

configure: configure.ac
	autoconf

XPL = list.def internal/scoping.def internal/checks.def \
      miniml.def 3bits.def lambda.def progs.def \
      graph-alt.def minmax.def multisim.def \
      tictactoe.def \
      pi/pi_trace.def pi/corr-assert.def pi/pi_modal.def \
      pi/pi_mini.def pi/pi_nat.def pi/pi_church.def

#	     doc/userguide.pdf doc/userguide.ps.gz doc/userguide.html 
ARCH_FILES = COPYING CHANGES README TODO configure.ac install-sh Makefile.in \
	     contrib/bedwyr.el contrib/bedwyr.vim \
	     doc/*.tex doc/userguide.bib doc/Makefile \
	     src/ndcore/term.ml src/ndcore/term.mli \
	     src/ndcore/norm.ml src/ndcore/norm.mli \
	     src/ndcore/unify.ml src/ndcore/unify.mli \
	     src/ndcore/index.ml src/ndcore/index.mli \
	     src/type.ml \
	     src/typing.ml src/typing.mli \
	     src/pprint.ml src/pprint.mli \
	     src/ndcore/tests/oUnit.ml \
	     src/ndcore/tests/test.ml \
	     src/table.ml src/table.mli \
	     src/system.ml src/system.mli \
	     src/prover.ml src/prover.mli \
	     src/config.ml.in src/parser.mly src/lexer.mll \
	     src/main.ml src/main.mli \
	     src/Makefile.in \
	     $(shell find examples -type f '!' -path '*.svn*' -exec echo \{\} +)

.PHONY: test
test: src/Makefile
	@echo Testing the core LLambda library
	make -C src test
	@echo Testing bedwyr on examples
	@bash -c 'time $(MAKE) examples_tests'

.PHONY: examples_tests
examples_tests: src/bedwyr
	@for i in $(XPL) ; do \
	  echo "==== Running tests in $$i ====" ; \
	  if src/bedwyr -t -I examples/$$i ; then echo "All done." ; else echo "Error." ; break ; fi ; \
	done

.PHONY: doc
doc:
	make -C src doc
	make -C doc

superclean: clean
	find . -name '*~' -exec rm \{\} \;
	rm -f src/depend
	rm -f src/ndcore/depend

clean:
	make -C src clean
	make -C doc clean

VERSION=@PACKAGE_VERSION@
D=bedwyr-$(VERSION)

#dist: Makefile doc $(D).tar.bz2 $(D).tar.gz
dist: Makefile $(D).tar.bz2 $(D).tar.gz

$(D).tar.bz2: $(ARCH_FILES)
	@tar -cvjf $@ --xform 's|^|$(D)/|' $^

$(D).tar.gz: $(ARCH_FILES)
	@tar -cvzf $@ --xform 's|^|$(D)/|' $^
