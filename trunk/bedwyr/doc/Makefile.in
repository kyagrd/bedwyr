# @configure_input@

# DEFINITIONS

PACKAGE_TARNAME	= @PACKAGE_TARNAME@
PACKAGE_VERSION	= @PACKAGE_VERSION@
DIST_NAME	= $(PACKAGE_TARNAME)-$(PACKAGE_VERSION)

SHELL	= @BASH@
LATEX	= @LATEX@
BIBTEX	= @BIBTEX@
DVIPS	= @DVIPS@ -t a4 -Ppdf -z
GZIP	= @GZIP@ -4 -f
PS2PDF	= @PS2PDF@ -sPAPERSIZE=a4
HEVEA	= @HEVEA@ png.hva
BIBHVA	= @BIBHVA@
IMAGEN	= @IMAGEN@ -png
HACHA	= @HACHA@ -tocbis
TAR	= @TAR@

# FILES

QUICKSTART	= quickstart-1.4
REFMAN		= refman-1.4

TEX_FILES	= $(QUICKSTART).tex $(REFMAN).tex
DVI_FILES	= $(TEX_FILES:.tex=.dvi)
PSGZ_FILES	= $(DVI_FILES:.dvi=.ps.gz)
PDF_FILES	= $(PSGZ_FILES:.ps.gz=.pdf)
HTML_FILES	= $(QUICKSTART).html $(REFMAN)/index.html

TARGETS		= $(PSGZ) $(PDF) $(HTML)

REFMAN_INCLUDES	=
BIB_FILE	= userguide.bib

# BUILDING

all: $(TARGETS)

$(REFMAN).aux: $(REFMAN_INCLUDES)
$(REFMAN).bbl: $(BIB_FILE)

.SUFFIXES: .tex .aux .bbl .dvi .ps .gz .pdf .haux .hbbl .html

.tex.aux:
	@$(LATEX) $*

.aux.bbl:
	@$(BIBTEX) $* || true

# This cancels the predefined .tex.dvi rule,
# which uses tex instead of latex,
# and which I don't want to redefine since
# depending on the bbl makes more sense dependency-wise.
# For some reason, ".tex.dvi:" doesn't cancel the rule.
%.dvi: %.tex

.bbl.dvi:
	@$(LATEX) $*
	@while ( grep -q "Rerun to get cross-references right" $*.log ) ; do \
	  echo 'Reruning latex to get cross-references right' ; \
	  $(LATEX) $* ; \
	  done

.dvi.ps:
	@$(DVIPS) $*

%.gz: %
	@$(GZIP) -c $<

.ps.pdf:
	@$(PS2PDF) $<

# The "-fix" option is needed to enforce the creation of $*.haux
# even if $*.aux is still present frpom a previous latex run
# (while hevea can use both, bibhva cannot).
.tex.haux:
#	echo "\documentclass{article}\begin{document}\end{document}" > $*.image.tex
	@$(HEVEA) -fix $*

.haux.hbbl:
	@$(BIBHVA) $*

.hbbl.html:
#	$(IMAGEN) $*
#	@echo $(HEVEA) $*
#	@while ( ($(HEVEA) $* 2>&1 | tee >(cat >&3) | grep -q "Rerun me to get cross-references right") 3>&1 ) ; do \
	  echo "Reruning hevea to get cross-references right" ; \
	  done
	@$(HEVEA) -fix $*

%/index.html: %.html
	  @mkdir -p $*
	  @$(HACHA) -o $@ $<
	  @for i in $**.png ; do mv -vf $$i $*/ ; done

# OTHER TARGETS

.PHONY: archive manual.tar

archive: manual.tar

manual.tar: $(TEX_FILES) $(REFMAN_INCLUDES) $(BIB_FILE) Makefile.in
	$(TAR) -cf $@ --xform 's|^|$(DIST_NAME)/doc/|' $^

# For this target, the aux file need to mention a bib file
# in Dale's LIX directory.
# Only he will be able to do the following command to create the
# userguide.bib file.
bib: $(BIB_FILE)

BIBREF	= ../../../../../pap/references/master
ifneq ($(strip $(wildcard $(BIBREF))),)
$(BIB_FILE): $(REFMAN).tex
	sed -e 's|^\\bibliography{userguide}$$|\\bibliography{$(BIBREF)}|' $< | $(LATEX) --jobname=$(<:.tex=) --
	aux2bib $(<:.tex=.aux) > $@
	rm -f $(<:.tex=.aux)
endif

.PHONY: tex_clean hevea_clean clean ocamldoc_clean distclean
tex_clean:
	@rm -fv *.aux *.out *.toc *.log *.dvi *.blg *.bbl *.idx *.ind *.ps

hevea_clean:
	@rm -fv *.haux *.html *.blg *.hbbl *.image.tex *.htoc *.hidx *.hind *_motif.gif *.css

clean: tex_clean hevea_clean

ocamldoc_clean:
	@rm -fv html/bedwyr/*

distclean: clean ocamldoc_clean
	@rm -fv $(TARGETS) *~
	@rm -fvr $(REFMAN)/
