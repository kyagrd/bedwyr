<html>
<head>
<title>Proof Explorer</title>
<script src="jquery.js"></script>
<script type="text/javascript">
$(function() {
  function render_rule(rule) {
    var subrules = $(rule).children('sub').children('rule');
    var active = $(rule).children('formula');
    var name = $(rule).children('name').text();
    var conc = $(rule).children('sequent');

    var upper = $('<tr></tr>');
    subrules.each(function(index, sr) {
      render_rule(sr).appendTo(upper).wrap('<td />');
    });
    if (subrules.size() === 0) {
      upper.append('<td></td>');
    }
    $('<sub></sub>').text(name).appendTo(upper).wrap('<td class="name"/>');

    var lower = $('<tr></tr>');
    lower.append($('<td></td>')
                   .attr('colspan', subrules.size())
                   .addClass('expandable')
                   .append(render_sequent(conc, active)));

    return $('<table></table>').append(upper).append(lower);
  }

  function render_sequent(sequent, active) {
    return (
      $('<span class="sequent"></span>')
        .append(render_lhs(sequent.children('lhs'), active))
        .append(' &rarr; ')
        .append(render_rhs(sequent.children('rhs'), active))
    );
  }

  function render_lhs(lhs, active) {
    var result = $('<span class="lhs"></span>');
    lhs.children('formula').each(function(index, form) {
      if (index > 0) {
        result.append(', ');
      }
      result.append(render_formula(form, active));
    });
    return result;
  }

  function render_rhs(rhs, active) {
    return (
      $('<span class="rhs"></span>')
        .append(render_formula(rhs.children('formula'), active))
    );
  }

  function render_formula(formula, active) {
    var generic = $(formula).children('generic').text();
    var is_active = ($(formula).text() === $(active).text());

    $(formula).children('generic').remove().text();
    var text = $(formula).text();
    var is_focused = /#/.test(text);
    var is_frozen = /\*/.test(text);

    var formula =
      $('<span class="formula"></span>')
        .toggleClass('active', is_active)
        .toggleClass('focused', is_focused)
        .toggleClass('frozen', is_frozen)
        .append(render_text(text));

    if (generic !== '') {
      formula.prepend(
        render_var(generic).replace(/,/g, ', ') + ' &rsaquo; ');
    }

    return formula;
  }

  function render_text(text) {
    return (
      render_var(text
        .replace(/;/g, ' &or;')        // needs to be first
        .replace(/,/g, ' &and;')       // needs to be before quantifiers
        .replace(/=>/g, '&sup;')
        .replace(/(pi|sigma|nabla) (?:\w+\\)+/g,
                 function(m) {
                   var r =
                     m.replace('sigma ', '&exist;')
                      .replace('pi ', '&forall;')
                      .replace('nabla ', '&nabla;')
                      .split('\\');
                    r.pop();
                    return (r.join(', ') + '.');
                 })
        .replace(/(\w+)\\/g, '&lambda;$1.')
        .replace(/#/g, '')
        .replace(/\*/g, '')
      )
    );
  }

  function render_var(v) {
     return (
       v.replace(/([A-Za-z_]+)([0-9]+)/g, '$1<sub>$2</sub>')
        .replace(/gamma/g, '&gamma;')
        .replace(/Gamma/g, '&Gamma;')
     );
  }

  function zoom(f) {
    $('td').css('font-size', '60%');
    $(f)
      .parents('table:first')
        .parents('table:first')
          .find('td').css('font-size', '80%').end()
        .end()
        .find('td').css('font-size', '100%').end()
      .end()
  }

  $('.expandable').live('click', function() {
    zoom(this);
    $(this).removeClass('expandable').addClass('expanded');
    $(this).parent().prev().fadeIn('slow');
  });

  $('.expanded').live('click', function() {
    $(this).removeClass('expanded').addClass('expandable');
    $(this).parent().prev().fadeOut('slow', function() {
      zoom(this);
    });
  });

  function load_proof(filename) {
    $.get(filename, function(xml) {
      $('#proof').html(render_rule($(xml).children('rule')))
      $('.expandable').parent().prev().hide();
    });
  }

  var proof_files =
    ['even_or_even_s.xml',
     'reverse_inverse.xml',
     'copy.xml'];

  load_proof(proof_files[0]);

  $.each(proof_files, function(index, file) {
    $('<a href="#">' + file.replace(/.xml$/, '') + '</a>')
      .appendTo($('#selector ul'))
      .click(function() {
        $('#proof').hide().html($('<p>Loading...</p>')).fadeIn('fast');
        load_proof(file);
        return false;
      })
      .wrap('<li></li>');
  });
});
</script>
<style type="text/css">
body {
  font-family: "Lucida Sans Unicode", sans-serif;
}

a {
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

td {
  text-align: center;
  vertical-align: bottom;
  white-space: nowrap;
  padding: 0px 10px;
}

td.expanded {
  border-top: 1px solid black;
  cursor: pointer;
}

td.expandable {
  border-top: 1px dotted grey;
  cursor: pointer;
}

.active {
  color: blue;
}

.focused {
  color: green;
}

.frozen {
  color: navy;
}

ul {
  margin: 5px 0px;
  list-style-type: circle;
}

#selector, #legend {
  margin: 1.5em 0;
}
</style>
</head>
<body>
<center>
  <div id="proof"></div>
</center>
<div id="selector">Select proof: <ul></ul></div>
<div id="legend">Legend:
<ul>
  <li class="active">Active</li>
  <li class="focused">Focused</li>
  <li class="frozen">Frozen</li>
</ul>
</div>
</body>
</html>
