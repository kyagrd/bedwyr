# DEFINITIONS

PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_VERSION = @PACKAGE_VERSION@
DIST_NAME       = $(PACKAGE_TARNAME)-$(PACKAGE_VERSION)

TAR	= @TAR@

prefix		= @prefix@
exec_prefix	= @exec_prefix@
nddocdir	= $(patsubst %$(PACKAGE_TARNAME),%ndcore,@docdir@)
libdir		= @libdir@

NDDOCDIR	= $(DESTDIR)$(nddocdir)
LIBDIR		= $(DESTDIR)$(libdir)/ocaml/slimmer

cmo = @cmo@
cma = @cma@
INCLUDES = -I ndcore
OCAMLDEP = @OCAMLDEP@
OCAMLC = @OCAMLC@ @OCAMLCFLAGS@ $(INCLUDES) \
	 -I $(LIBDIR) -I $(shell ocamlc -where)/slimmer -c
OCAMLL = @OCAMLC@ @OCAMLLFLAGS@ $(INCLUDES) \
	 -I $(LIBDIR) -I $(shell ocamlc -where)/slimmer
OCAMLDOC = @OCAMLDOC@ $(INCLUDES) \
	   -I $(LIBDIR) -I $(shell ocamlc -where)/slimmer \
	   -stars -m A
OCAMLYACC = @OCAMLYACC@ -v
OCAMLLEX = @OCAMLLEX@

# SOURCE FILES

BEDWYR_MLLY= table.ml system.ml prover.ml \
	     config.ml parser.mly lexer.mll \
	     main.ml
BEDWYR_MLL = $(BEDWYR_MLLY:.mly=.ml)
BEDWYR_ML  = $(BEDWYR_MLL:.mll=.ml)

BEDWYR_MLI = $(filter-out parser.mli,$(wildcard $(BEDWYR_ML:.ml=.mli)))

BEDWYR_SRC = $(BEDWYR_ML) $(BEDWYR_MLI)

BEDWYR_FILES = $(BEDWYR_MLLY) $(BEDWYR_MLI)

BEDWYR_O = $(BEDWYR_ML:.ml=.$(cmo))

# BUILDING

all: bedwyr

ifneq ($(strip $(wildcard ndcore/ndcore.$(cma))),)
bedwyr: ndcore/ndcore.$(cma) $(BEDWYR_O)
	$(OCAMLL) unix.$(cma) $^ -o $@
else
bedwyr: $(BEDWYR_O)
	$(OCAMLL) unix.$(cma) ndcore.$(cma) $^ -o $@
endif

-include depend
depend: $(BEDWYR_SRC) parser.mli
	$(OCAMLDEP) $^ > depend

.SUFFIXES: .mll .mly .ml .cmo .cmx .mli .cmi

.ml.$(cmo):
	$(OCAMLC) $<
.mli.cmi:
	$(OCAMLC) $<
%.ml %.mli: %.mly
	$(OCAMLYACC) $<
.mll.ml:
	$(OCAMLLEX) $<

# OTHER TARGETS

.PHONY: doc bedwyr.tar

ifneq ($(strip $(wildcard ndcore/ocamldoc.dump)),)
NDCORE_DUMP	= -load ndcore/ocamldoc.dump
else
  ifneq ($(strip $(wildcard $(NDDOCDIR)/ocamldoc.dump)),)
NDCORE_DUMP	= -load $(NDDOCDIR)/ocamldoc.dump
  endif
endif

doc: ../doc/html/bedwyr/index.html

../doc/html/bedwyr/index.html: $(BEDWYR_O)
ifneq (@OCAMLDOC@,)
	mkdir -p ../doc/html/bedwyr
	$(OCAMLDOC) -d ../doc/html/bedwyr -html $(BEDWYR_MLI) \
	  $(NDCORE_DUMP)
endif

archive: bedwyr.tar

bedwyr.tar: $(filter-out config.ml,$(BEDWYR_FILES)) config.ml.in Makefile.in
	$(TAR) -cf $@ --xform 's|^|$(DIST_NAME)/src/|' $^

.PHONY: clean
clean:
	rm -f depend
	rm -f bedwyr
	rm -f *.cm[ixoa] *.cmxa *.[oa]
	rm -f parser.ml parser.mli parser.output lexer.ml
	rm -f bedwyr.tar
	rm -f ../doc/html/bedwyr/*
