
all: bedwyr

# DEFINITIONS

cmo = @cmo@
cma = @cma@
OCAMLC = @OCAMLC@ @OCAMLCFLAGS@ -c -I ndcore -I ndcore/tests
OCAMLL = @OCAMLC@ @OCAMLLFLAGS@
OCAMLDEP = @OCAMLDEP@ -I ndcore -I ndcore/tests
OCAMLDOC = @OCAMLDOC@ -m A -I ndcore/
OCAMLYACC = @OCAMLYACC@ -v
OCAMLLEX = @OCAMLLEX@
VERSION = @PACKAGE_VERSION@

# SOURCE FILES

CORE_ML    = ndcore/term.ml ndcore/norm.ml ndcore/unify.ml ndcore/index.ml \
	     ndcore/type.ml ndcore/typing.ml ndcore/pprint.ml
TEST_ML    = ndcore/tests/oUnit.ml ndcore/tests/test.ml
BEDWYR_ML  = table.ml system.ml prover.ml \
	     config.ml parser.ml lexer.ml \
	     main.ml

CORE_SRC   = $(CORE_ML)   $(wildcard $(CORE_ML:.ml=.mli))
BEDWYR_SRC = $(BEDWYR_ML) $(wildcard $(BEDWYR_ML:.ml=.mli))

BEDWYR = $(CORE_ML:.ml=.$(cmo)) $(BEDWYR_ML:.ml=.$(cmo))
TEST   = $(CORE_ML:.ml=.$(cmo)) $(TEST_ML:.ml=.$(cmo))

# BUILDING

bedwyr: $(BEDWYR)
	$(OCAMLL) unix.$(cma) $(BEDWYR) -o bedwyr

-include depend
depend: $(CORE_SRC) $(BEDWYR_SRC) $(TEST_ML)
	$(OCAMLDEP) $(CORE_SRC) $(BEDWYR_SRC) $(TEST_ML) > depend

%.$(cmo): %.ml
	$(OCAMLC) $<
%.cmi: %.mli
	$(OCAMLC) $<
%.ml: %.mly
	$(OCAMLYACC) $<
%.mli: %.mly
	$(OCAMLYACC) $<
%.ml: %.mll
	$(OCAMLLEX) $<
%.ml: %.ml.in
	@sed -e 's|{VERSION}|$(VERSION)|'\
	  -e 's|{BUILD}|$(shell (svn info 2>&- || git svn info 2>&-) | grep Revision | sed -e "s/Revision: //")|'\
	  $^ > $@

# TARGETS FOR CORE LLAMBDA MODULES

test: ndcore/test
	ndcore/test
ndcore/test: $(TEST)
	$(OCAMLL) unix.$(cma) $(TEST) -o ndcore/test

doc:
ifneq (@OCAMLDOC@,)
	$(OCAMLDOC) -stars -d ../doc -html $(CORE_SRC) $(BEDWYR_SRC)
endif

# MISC

run: bedwyr
	ledit ./bedwyr

.PHONY: clean

clean:
	rm -f bedwyr
	rm -f Makefile
	rm -f ndcore/test
	rm -f config.ml parser.ml parser.mli lexer.ml parser.output
	rm -f *.cm[ixo] *.o
	rm -f ndcore/*.cm[ixo] ndcore/*.o
	rm -f ndcore/tests/*.cm[ixo] ndcore/tests/*.o
	make -C ../doc clean
