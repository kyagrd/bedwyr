# DEFINITIONS

PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_VERSION = @PACKAGE_VERSION@
DIST_NAME       = $(PACKAGE_TARNAME)-$(PACKAGE_VERSION)

SHELL	= @BASH@
TAR	= @TAR@

prefix		= @prefix@
exec_prefix	= @exec_prefix@
libdir		= @libdir@

LIBDIR		= $(DESTDIR)$(libdir)/ocaml/slimmer

cmo = @cmo@
cma = @cma@
INCLUDES = -I tests
OCAMLDEP = @OCAMLDEP@ $(INCLUDES)
OCAMLC = @OCAMLC@ @OCAMLCFLAGS@ $(INCLUDES) \
	 -I $(LIBDIR) -I $(shell ocamlc -where)/slimmer -c
OCAMLL = @OCAMLC@ @OCAMLLFLAGS@ $(INCLUDES) \
	 -I $(LIBDIR) -I $(shell ocamlc -where)/slimmer
OCAMLDOC = @OCAMLDOC@ \
	   -stars -m A

# SOURCE FILES

NDCORE_ML  = term.ml norm.ml unify.ml index.ml type.ml typing.ml pprint.ml
TEST_ML    = tests/oUnit.ml tests/test.ml

NDCORE_MLI = $(wildcard $(NDCORE_ML:.ml=.mli))
TEST_MLI = $(wildcard $(TEST_ML:.ml=.mli))

NDCORE_SRC = $(NDCORE_ML) $(NDCORE_MLI)
TEST_SRC   = $(TEST_ML) $(TEST_MLI)

NDCORE_O = $(NDCORE_ML:.ml=.$(cmo))
TEST_O   = $(TEST_ML:.ml=.$(cmo))

# BUILDING

all: ndcore.$(cma) ndcore.cmi.tar

# TODO build ndcore.cma *and* ndcore.cmxa,
# since it must be installed as a lib,
# not just used during the compilation of bedwyr
ndcore.$(cma): $(NDCORE_O)
	$(OCAMLL) $^ -a -o $@

ndcore.cmi.tar: $(NDCORE_ML:.ml=.cmi)
	$(TAR) -cf $@ $^

tests/test: ndcore.$(cma) $(TEST_O)
	$(OCAMLL) unix.$(cma) $^ -o $@

-include depend
depend: $(NDCORE_SRC) $(TEST_SRC)
	$(OCAMLDEP) $^ > depend

.SUFFIXES: .mll .mly .ml .cmo .cmx .mli .cmi

.ml.$(cmo):
	$(OCAMLC) $<
.mli.cmi:
	$(OCAMLC) $<

# OTHER TARGETS

.PHONY: test doc archive ndcore.tar

test: tests/test
	./$<

doc: ../../doc/html/ndcore/index.html

../../doc/html/ndcore/index.html: $(NDCORE_O)
ifneq (@OCAMLDOC@,)
	mkdir -p ../../doc/html/ndcore
	$(OCAMLDOC) -dump ocamldoc.dump $(NDCORE_MLI)
	$(OCAMLDOC) -load ocamldoc.dump -d ../../doc/html/ndcore -html
endif

archive: ndcore.tar

ndcore.tar: $(NDCORE_SRC) $(TEST_SRC) Makefile.in
	$(TAR) -cf $@ --xform 's|^|$(DIST_NAME)/src/ndcore/|' $^

.PHONY: clean
clean:
	@rm -vf depend
	@rm -vf *.cm[ixoa] *.cmxa *.[oa] a.out
	@rm -vf tests/test
	@rm -vf tests/*.cm[ixoa] tests/*.cmxa tests/*.[oa]
	@rm -vf ndcore.tar ndcore.cmi.tar ocamldoc.dump ocamldoc.dump.bz2
	@rm -vf ../../doc/html/ndcore/*
