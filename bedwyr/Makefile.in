# Makefile.in designed for ndcore/bedwyr
#
# $(make TARGET=$TARGET) compiles
# $(make TARGET=$TARGET install) installs
# $(make TARGET=$TARGET dist) builds packages
#
# $TARGET can be "ndcore" for this library only,
# "bedwyr" for the program only (requires ndcore to either
# havinge been compiled just before, installed in a custom place
# wrt the current Makefile config, or installed in a standard place),
# and "" for both (in which case all the doc will be in /u/s/d/bedwyr).

# DEFINITIONS

PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_VERSION = @PACKAGE_VERSION@
DIST_NAME       = $(PACKAGE_TARNAME)-$(PACKAGE_VERSION)
ifeq ($(TARGET),)
PACKAGE_NAME = $(PACKAGE_TARNAME)
else
PACKAGE_NAME = $(TARGET)
endif

TAR	= @TAR@ -p
FIND	= @FIND@
BZIP2	= bzip2 -9
GZIP	= gzip -9

prefix        =@prefix@
exec_prefix   =@exec_prefix@
bindir        =@bindir@
#sbindir       =@sbindir@
#libexecdir    =@libexecdir@
datarootdir   =@datarootdir@
#datadir       =@datadir@
#sysconfdir    =@sysconfdir@
#sharedstatedir=@sharedstatedir@
#localstatedir =@localstatedir@
#includedir    =@includedir@
#oldincludedir =@oldincludedir@
docdir        =$(patsubst %$(PACKAGE_TARNAME),%$(PACKAGE_NAME),@docdir@)
#infodir       =@infodir@
htmldir       =@htmldir@
#dvidir        =@dvidir@
pdfdir        =@pdfdir@
psdir         =@psdir@
libdir        =@libdir@
#localedir     =@localedir@
mandir        =@mandir@

PREFIX        =$(DESTDIR)$(prefix)
EXEC_PREFIX   =$(DESTDIR)$(exec_prefix)
BINDIR        =$(DESTDIR)$(bindir)
#SBINDIR       =$(DESTDIR)$(sbindir)
#LIBEXECDIR    =$(DESTDIR)$(libexecdir)
DATAROOTDIR   =$(DESTDIR)$(datarootdir)
#DATADIR       =$(DESTDIR)$(datadir)
#SYSCONFDIR    =$(DESTDIR)$(sysconfdir)
#SHAREDSTATEDIR=$(DESTDIR)$(sharedstatedir)
#LOCALSTATEDIR =$(DESTDIR)$(localstatedir)
#INCLUDEDIR    =$(DESTDIR)$(includedir)
#OLDINCLUDEDIR =$(DESTDIR)$(oldincludedir)
DOCDIR        =$(DESTDIR)$(docdir)
#INFODIR       =$(DESTDIR)$(infodir)
HTMLDIR       =$(DESTDIR)$(htmldir)
#DVIDIR        =$(DESTDIR)$(dvidir)
PDFDIR        =$(DESTDIR)$(pdfdir)
PSDIR         =$(DESTDIR)$(psdir)
LIBDIR        =$(DESTDIR)$(libdir)/ocaml/slimmer
#LOCALEDIR     =$(DESTDIR)$(localedir)
MANDIR        =$(DESTDIR)$(mandir)

VIMFILES = $(DATAROOTDIR)/vim/vimfiles

INSTALL     = @INSTALL@
INSTALL_OPTS=-v
INSTALL_DIR = @INSTALL_PROGRAM@ $(INSTALL_OPTS) -d
INSTALL_BIN = @INSTALL_PROGRAM@ $(INSTALL_OPTS) -p
INSTALL_DOC = @INSTALL_DATA@ $(INSTALL_OPTS) -p

cma = @cma@

# FILES

XPL = list.def internal/scoping.def internal/checks.def \
      3bits.def lambda.def progs.def \
      graph-alt.def minmax.def multisim.def \
      tictactoe.def \
      pi/pi_trace.def pi/corr-assert.def pi/pi_modal.def \
      pi/pi_asserts.def

# debhelper has his own tools to install those standard docs
ifeq ($(DISTRIB),debian)
NDCORE_DOCS	=
BEDWYR_DOCS	=
else
NDCORE_DOCS	= COPYING ChangeLog README TODO
BEDWYR_DOCS	= COPYING ChangeLog README TODO
endif
DOCS		= $(BEDWYR_DOCS)
VIM_CONTRIB	= ftdetect/bedwyr.vim \
		  syntax/bedwyr.vim
CONTRIB		= contrib/emacs/bedwyr.el \
		  $(VIM_CONTRIB:%=contrib/vim/%)
EXAMPLES	= $(shell find examples -type f '!' -path '*.svn*' \
		  '!' -name \*~ '!' -name .\*.sw\* '!' -name \*.old)
USERGUIDE	= userguide-1.3
TEX_FILES	= $(USERGUIDE).tex
PS_FILES	= $(USERGUIDE).ps.gz
PDF_FILES	= $(USERGUIDE).pdf
HTML_FILES	= $(USERGUIDE).html
USERGUIDE_FILES	= doc/$(TEX_FILES) doc/userguide.bib doc/Makefile.in
ARCH_FILES	= configure.ac Makefile.in install-sh \
		  $(DOCS) $(CONTRIB) $(EXAMPLES) \
		  $(USERGUIDE_FILES)

ndcore = src/ndcore/ndcore.$(cma)
bedwyr = src/bedwyr

# BUILDING

.PHONY: $(ndcore) $(bedwyr)

all: Makefile
ifeq ($(TARGET),ndcore)
	$(MAKE) $(ndcore)
else ifeq ($(TARGET),bedwyr)
	$(MAKE) $(bedwyr)
else ifeq ($(TARGET),)
	$(MAKE) $(ndcore)
	$(MAKE) $(bedwyr)
endif

$(bedwyr): src/Makefile
	$(MAKE) -C src

$(ndcore) $(ndcore:$(cma)=a): src/ndcore/Makefile
	$(MAKE) -C src/ndcore

%: configure %.in
	./$<

configure: configure.ac
	autoconf

# TESTING

.PHONY: test test_ndcore test_bedwyr

test:
ifeq ($(TARGET),)
	$(MAKE) test_ndcore
	$(MAKE) test_bedwyr
else
	$(MAKE) test_$(TARGET)
endif

test_ndcore: $(ndcore)
	@echo Testing the core LLambda library
	$(MAKE) -C src/ndcore test

test_bedwyr: $(bedwyr)
	@echo Testing bedwyr on examples
	@bash -c 'time for i in $(XPL) ; do \
	  echo "==== Running tests in $$i ====" ; \
	  if $< -t -I examples/$$i ; then echo "All done." ; \
	  else echo "Error." ; break ; fi ; \
	  done'

# DOC

.PHONY: doc bedwyr_doc

ifeq (@OCAMLDOC@,)
doc:
	@echo "Documentation generation disabled,"
	@echo "run \"./configure --enable-doc\" to enable it."
else
  ifeq ($(TARGET),)
doc: ndcore_doc bedwyr_doc
  else
doc: $(TARGET)_doc
  endif
endif

NDCORE_DUMP	= src/ndcore/ocamldoc.dump

ndcore_doc $(NDCORE_DUMP):
	$(MAKE) -C src/ndcore doc

bedwyr_doc: doc/Makefile
	$(MAKE) -C src doc
	$(MAKE) -j1 -C doc

# INSTALL

ifeq ($(TARGET),)
install: install_ndcore install_bedwyr
else
install: install_$(TARGET)
endif

ifneq (@OCAMLDOC@,)
install_ndcore: install_ndcore_doc
install_bedwyr: install_bedwyr_doc
endif

install_ndcore: $(ndcore) $(NDCORE_DOCS:=.bz2)
	@$(INSTALL_DIR) $(LIBDIR)
	$(INSTALL_DOC) $(ndcore) $(wildcard $(ndcore:$(cma)=a)) $(LIBDIR)
	$(TAR) -xf $(ndcore:$(cma)=cmi.tar) -C $(LIBDIR)
	@$(INSTALL_DIR) $(DOCDIR)
ifneq ($(NDCORE_DOCS:=.bz2),)
	@$(INSTALL_DOC) $(NDCORE_DOCS:=.bz2) $(DOCDIR)
endif

install_ndcore_doc: ndcore_doc $(NDCORE_DUMP:=.bz2)
	@$(INSTALL_DIR) $(HTMLDIR)/ref
	@$(INSTALL_DOC) doc/html/ndcore/style.css doc/html/ndcore/*.html \
	  $(HTMLDIR)/ref
	@$(INSTALL_DOC) $(NDCORE_DUMP:=.bz2) $(DOCDIR)

install_bedwyr: $(bedwyr) $(BEDWYR_DOCS:=.bz2)
	@$(INSTALL_DIR) $(BINDIR)
	@$(INSTALL_BIN) $(bedwyr) $(BINDIR)
	@$(INSTALL_DIR) $(DOCDIR)
ifneq ($(BEDWYR_DOCS:=.bz2),)
	@$(INSTALL_DOC) $(BEDWYR_DOCS:=.bz2) $(DOCDIR)
endif
	@$(INSTALL_DIR) $(DATAROOTDIR)/$(PACKAGE_NAME)
	@for i in $(CONTRIB) ; do \
	  $(INSTALL_DOC) -D $$i $(DATAROOTDIR)/$(PACKAGE_NAME)/$$i ; done
	@for i in $(VIM_CONTRIB) ; do \
	  $(INSTALL_DOC) -D contrib/vim/$$i $(VIMFILES)/$$i ; done
	@for i in $(EXAMPLES) ; do \
	  $(INSTALL_DOC) -D $$i $(DATAROOTDIR)/$(PACKAGE_NAME)/$$i ; done

install_bedwyr_doc: bedwyr_doc
	@$(INSTALL_DIR) $(PSDIR)
	@$(INSTALL_DIR) $(PDFDIR)
	@$(INSTALL_DIR) $(HTMLDIR)
	@$(INSTALL_DOC) doc/$(PS_FILES) $(PSDIR)
	@$(INSTALL_DOC) doc/$(PDF_FILES) $(PDFDIR)
	@$(INSTALL_DOC) doc/$(HTML_FILES) $(HTMLDIR)
	@$(INSTALL_DIR) $(HTMLDIR)/ref
	@$(INSTALL_DOC) doc/html/bedwyr/style.css doc/html/bedwyr/*.html \
	  $(HTMLDIR)/ref

# ARCHIVE

.PHONY: dist src/ndcore/ndcore.tar src/bedwyr.tar dist.tar

dist: Makefile
	$(MAKE) $(DIST_NAME).tar.bz2
	$(MAKE) $(DIST_NAME).tar.gz

src/ndcore/ndcore.tar:
	$(MAKE) -C src/ndcore archive

src/bedwyr.tar:
	$(MAKE) -C src archive

dist.tar: $(ARCH_FILES)
	$(TAR) -cf $@ --xform 's|^|$(DIST_NAME)/|' $^

$(DIST_NAME).tar: src/ndcore/ndcore.tar src/bedwyr.tar dist.tar
	$(TAR) -cf $@ -T /dev/null
	for i in $^ ; do \
	  $(TAR) -Af $@ $$i ; done

%.bz2: %
	$(BZIP2) -f -k $<
%.gz: %
	$(GZIP) -f -c $< > $@

# OTHER TARGETS

.PHONY: help clean distclean

help:
	@echo " help           this message"
	@echo
	@echo " all (default)  compiles the library/program wrt \$$TARGET"
	@echo " test           runs a test on ndcore, then on bedwyr"
	@echo " doc            compiles the doc from the sources wrt \$$TARGET"
	@echo "                (requires the compilation of the lib/program)"
	@echo
	@echo " install        install the files wrt to the command-line"
	@echo "                variables \$$DESTDIR and \$$TARGET and the"
	@echo "                parameters given to ./configure"
	@echo
	@echo " dist           build $(DIST_NAME).tar.bz2"
	@echo "                and $(DIST_NAME).tar.gz"
	@echo
	@echo " help           display this message"
	@echo " distclean      remove almost all generated files"
	@echo " clean          remove compiled files"
	@echo
	@echo " \$$TARGET can be \"ndcore\" (for the library only), \"bedwyr\""
	@echo " (for the programm only, requires ndcore to be previously"
	@echo " compiled or installed), or \"\" (default, compiles both)"

distclean: clean
	find . -name '*~' -exec rm \{\} \;
	rm -f *.bz2 *.gz *.tar
	rm -f config.status config.log
	rm -f src/config.ml
	rm -f configure
	rm -f Makefile
	rm -f src/Makefile
	rm -f src/ndcore/Makefile
	rm -rf autom4te.cache

clean:
	$(MAKE) -C src clean
	$(MAKE) -C src/ndcore clean
	$(MAKE) -C doc clean
